<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IELTS Task 2 Professional Evaluator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=Merriweather:wght@300;400;700&display=swap');
        
        :root {
            --primary: #2563eb;
            --success: #16a34a;
            --warning: #ca8a04;
            --bg-soft: #f1f5f9;
        }

        body {
            font-family: 'Inter', sans-serif;
            background-color: #f8fafc;
            color: #1e293b;
        }

        .serif-text { font-family: 'Merriweather', serif; }

        /* Scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: transparent; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }

        /* Glassmorphism */
        .glass-panel {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.5);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05), 0 10px 15px -3px rgba(0, 0, 0, 0.05);
        }

        /* Animations */
        .fade-in-up { animation: fadeInUp 0.6s ease-out forwards; opacity: 0; transform: translateY(20px); }
        @keyframes fadeInUp { to { opacity: 1; transform: translateY(0); } }
        
        /* Mobile Tweaks */
        .custom-scroll { -webkit-overflow-scrolling: touch; }
    </style>
</head>
<body class="h-screen flex flex-col overflow-hidden">

    <header class="bg-white border-b border-slate-200 h-16 flex-none z-20">
        <div class="max-w-[1800px] mx-auto px-4 md:px-6 h-full flex justify-between items-center">
            <div class="flex items-center gap-3">
                <div class="w-8 h-8 md:w-10 md:h-10 bg-blue-600 rounded-xl flex items-center justify-center text-white shadow-lg shadow-blue-500/30 shrink-0">
                    <i class="fa-solid fa-pen-nib text-sm md:text-base"></i>
                </div>
                <div>
                    <h1 class="font-bold text-slate-800 text-base md:text-lg leading-tight">IELTS <span class="text-blue-600">Evaluator Pro</span></h1>
                    <p class="text-[10px] md:text-[11px] font-medium text-slate-400 uppercase tracking-wider md:block">IG:@amir.in.english</p>
                </div>
            </div>
            <div class="hidden md:flex gap-6 text-sm font-medium text-slate-500">
                <span class="flex items-center gap-2"><i class="fa-regular fa-clock"></i> 40 Minutes</span>
                <span class="flex items-center gap-2"><i class="fa-solid fa-align-left"></i> Min 250 Words</span>
            </div>
            <div class="md:hidden text-slate-400">
                 <i class="fa-regular fa-clock mr-1"></i> 40m
            </div>
        </div>
    </header>

    <div class="flex-grow flex flex-col lg:flex-row overflow-y-auto lg:overflow-hidden max-w-[1800px] mx-auto w-full">
        
        <div class="w-full lg:w-[45%] flex flex-col border-b lg:border-b-0 lg:border-r border-slate-200 bg-white shrink-0 h-auto min-h-[80vh] lg:h-full">
            <div class="p-4 md:p-6 border-b border-slate-100 bg-slate-50/50">
                <div class="flex justify-between items-center mb-2">
                    <label class="text-xs font-bold text-slate-500 uppercase tracking-wide">Essay Prompt</label>
                    <button onclick="setRandomPrompt()" class="text-xs text-blue-600 hover:text-blue-700 font-medium transition-colors">
                        <i class="fa-solid fa-shuffle mr-1"></i> <span class="hidden md:inline">Generate</span> Random
                    </button>
                </div>
                <textarea id="promptInput" class="w-full bg-white border border-slate-200 rounded-lg p-3 text-sm focus:ring-2 focus:ring-blue-500/50 outline-none resize-none h-20 md:h-24 transition-all shadow-sm" placeholder="Paste the essay question here to check Topic Relevance..."></textarea>
            </div>

            <div class="flex-grow flex flex-col relative">
                <div class="absolute top-0 left-0 right-0 bg-gradient-to-b from-white to-transparent h-6 z-10 pointer-events-none"></div>
                <textarea id="essayInput" class="flex-grow w-full p-4 md:p-8 outline-none resize-none serif-text text-slate-700 text-base md:text-lg leading-7 md:leading-8 min-h-[300px]" placeholder="Start writing your essay here..."></textarea>
                
                <div class="p-3 md:p-4 border-t border-slate-100 bg-white flex justify-between items-center sticky bottom-0 z-20">
                    <span id="wordCountDisplay" class="text-xs md:text-sm font-mono text-slate-500 bg-slate-100 px-2 md:px-3 py-1 rounded-full">0 words</span>
                    <div class="flex gap-2 md:gap-3">
                        <button onclick="loadDemo()" class="px-3 py-2 text-xs md:text-sm font-medium text-slate-600 hover:bg-slate-100 rounded-lg transition-colors">Load Demo</button>
                        <button onclick="analyzeEssay()" class="px-4 md:px-6 py-2 bg-blue-600 hover:bg-blue-700 text-white text-xs md:text-sm font-bold rounded-lg shadow-lg shadow-blue-600/20 transition-all flex items-center gap-2">
                            <i class="fa-solid fa-wand-magic-sparkles"></i> Analyze <span class="hidden md:inline">Now</span>
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div id="rightPanel" class="w-full lg:w-[55%] bg-slate-50/50 lg:overflow-y-auto h-auto lg:h-full custom-scroll relative border-t lg:border-t-0 border-slate-200">
            
            <div id="emptyState" class="flex flex-col items-center justify-center text-center p-8 md:p-12 min-h-[300px] lg:min-h-full">
                <div class="w-16 h-16 md:w-20 md:h-20 bg-white rounded-full flex items-center justify-center shadow-sm mb-6 border border-slate-100">
                    <i class="fa-solid fa-chart-pie text-2xl md:text-3xl text-slate-300"></i>
                </div>
                <h3 class="text-lg font-bold text-slate-700 mb-2">Ready to Evaluate</h3>
                <p class="text-slate-400 max-w-sm text-sm">Enter your essay on the left (or top). We use official band descriptor logic to calculate TR, CC, LR, and GRA.</p>
            </div>

            <div id="resultsContainer" class="hidden p-4 md:p-8 pb-20 space-y-6 md:space-y-8">
                
                <div class="glass-panel rounded-2xl p-6 md:p-8 flex flex-col md:flex-row items-center justify-between fade-in-up bg-gradient-to-br from-slate-900 to-slate-800 text-white border-none gap-4">
                    <div class="w-full md:w-auto">
                        <div class="text-blue-400 font-bold text-xs uppercase tracking-widest mb-2">Calculated Band Score</div>
                        <div class="flex items-baseline gap-4">
                            <span id="scoreBig" class="text-5xl md:text-7xl font-black tracking-tighter">0.0</span>
                            <div class="flex flex-col">
                                <span id="cefrLevel" class="px-3 py-0.5 rounded-full bg-white/10 text-sm font-semibold border border-white/20 w-max">B2 Upper</span>
                                <span class="text-slate-400 text-sm mt-1">Official Scale</span>
                            </div>
                        </div>
                    </div>
                    <div class="text-left md:text-right w-full md:w-auto md:max-w-xs">
                        <p id="scoreSummary" class="text-slate-300 text-sm leading-relaxed italic">"A solid essay that addresses the task..."</p>
                    </div>
                </div>

                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 md:gap-6">
                    
                    <div class="glass-panel rounded-xl p-5 md:p-6 border-t-4 border-green-500 fade-in-up" style="animation-delay: 0.1s">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <h3 class="font-bold text-slate-800 text-base md:text-lg">Task Response</h3>
                                <p class="text-xs text-slate-500">Relevance & Development</p>
                            </div>
                            <span id="trScore" class="bg-green-100 text-green-700 font-bold px-3 py-1 rounded-lg text-base md:text-lg">0.0</span>
                        </div>
                        <p id="trFeedback" class="text-sm text-slate-600 leading-relaxed mb-4">Analysis pending...</p>
                        <div class="space-y-2">
                            <div class="flex justify-between text-xs font-medium uppercase text-slate-400">
                                <span>Word Count Check</span>
                                <span id="trCheckWords" class="text-slate-700">0 / 250</span>
                            </div>
                            <div class="h-1.5 w-full bg-slate-100 rounded-full overflow-hidden">
                                <div id="trBar" class="h-full bg-green-500 w-0 transition-all duration-1000"></div>
                            </div>
                        </div>
                    </div>

                    <div class="glass-panel rounded-xl p-5 md:p-6 border-t-4 border-blue-500 fade-in-up" style="animation-delay: 0.2s">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <h3 class="font-bold text-slate-800 text-base md:text-lg">Coherence & Cohesion</h3>
                                <p class="text-xs text-slate-500">Flow & Paragraphing</p>
                            </div>
                            <span id="ccScore" class="bg-blue-100 text-blue-700 font-bold px-3 py-1 rounded-lg text-base md:text-lg">0.0</span>
                        </div>
                        <p id="ccFeedback" class="text-sm text-slate-600 leading-relaxed mb-4">Analysis pending...</p>
                        <div class="flex gap-2 flex-wrap" id="connectorTags">
                            </div>
                    </div>

                    <div class="glass-panel rounded-xl p-5 md:p-6 border-t-4 border-purple-500 fade-in-up" style="animation-delay: 0.3s">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <h3 class="font-bold text-slate-800 text-base md:text-lg">Lexical Resource</h3>
                                <p class="text-xs text-slate-500">Vocabulary Range</p>
                            </div>
                            <span id="lrScore" class="bg-purple-100 text-purple-700 font-bold px-3 py-1 rounded-lg text-base md:text-lg">0.0</span>
                        </div>
                        <p id="lrFeedback" class="text-sm text-slate-600 leading-relaxed mb-4">Analysis pending...</p>
                        <div class="bg-purple-50 rounded-lg p-3 border border-purple-100">
                            <div class="text-xs font-bold text-purple-800 uppercase mb-2 flex items-center gap-2">
                                <i class="fa-solid fa-diamond"></i> High-Level Words Found
                            </div>
                            <div id="vocabList" class="flex flex-wrap gap-1.5"></div>
                        </div>
                    </div>

                    <div class="glass-panel rounded-xl p-5 md:p-6 border-t-4 border-orange-500 fade-in-up" style="animation-delay: 0.4s">
                        <div class="flex justify-between items-start mb-4">
                            <div>
                                <h3 class="font-bold text-slate-800 text-base md:text-lg">Grammar</h3>
                                <p class="text-xs text-slate-500">Range & Accuracy</p>
                            </div>
                            <span id="graScore" class="bg-orange-100 text-orange-700 font-bold px-3 py-1 rounded-lg text-base md:text-lg">0.0</span>
                        </div>
                        <p id="graFeedback" class="text-sm text-slate-600 leading-relaxed mb-4">Analysis pending...</p>
                        <div class="grid grid-cols-2 gap-2 text-center">
                            <div class="bg-orange-50 p-2 rounded border border-orange-100">
                                <div id="sentLenAvg" class="text-base md:text-lg font-bold text-orange-600">0</div>
                                <div class="text-[10px] text-orange-800 uppercase">Avg Words/Sent</div>
                            </div>
                            <div class="bg-orange-50 p-2 rounded border border-orange-100">
                                <div id="complexScore" class="text-base md:text-lg font-bold text-orange-600">0%</div>
                                <div class="text-[10px] text-orange-800 uppercase">Complexity</div>
                            </div>
                        </div>
                    </div>

                </div>

                <div class="glass-panel rounded-xl p-5 md:p-8 fade-in-up" style="animation-delay: 0.5s">
                    <h3 class="font-bold text-slate-800 text-lg mb-6 flex items-center gap-2">
                        <i class="fa-solid fa-clipboard-list text-blue-500"></i>
                        Specific Recommendations
                    </h3>
                    
                    <div class="space-y-4">
                        <div id="repetitionBox" class="flex gap-4 items-start p-4 bg-red-50 rounded-lg border border-red-100 hidden">
                            <div class="text-red-500 mt-1"><i class="fa-solid fa-triangle-exclamation"></i></div>
                            <div>
                                <h4 class="text-sm font-bold text-red-800">Vocabulary Repetition</h4>
                                <p class="text-sm text-red-700 mt-1">You used these words frequently. Try synonyms:</p>
                                <div id="repList" class="mt-2 flex flex-wrap gap-2"></div>
                            </div>
                        </div>

                         <div class="flex gap-4 items-start p-4 bg-blue-50 rounded-lg border border-blue-100">
                            <div class="text-blue-500 mt-1"><i class="fa-solid fa-lightbulb"></i></div>
                            <div>
                                <h4 class="text-sm font-bold text-blue-800">To Reach the Next Band</h4>
                                <ul id="nextStepsList" class="mt-2 space-y-2 text-sm text-blue-700 list-disc list-inside">
                                    </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <center>
            <hr>
            <small>
                <i>
                    <br>
                    Teacher Amir Ghorbani
                    <br>
                    Instagram: @amir.in.english
                    <br><br>
                </i>
            </small>
        </center>

    </div>

<script>
    /* --- DATA & CONSTANTS --- */
    // Expanded for better detection
    const ACADEMIC_VOCAB = new Set([
        "analysis", "approach", "assessment", "assumption", "authority", "available", "benefit", "concept", "consistent", "constitutional",
        "context", "contract", "create", "data", "definition", "derive", "distribution", "economic", "environment", "established",
        "estimate", "evidence", "export", "factors", "financial", "formula", "function", "identified", "income", "indicate",
        "individual", "interpretation", "involved", "issues", "labor", "legal", "legislation", "major", "method", "occur",
        "percent", "period", "policy", "principle", "procedure", "process", "required", "research", "response", "role",
        "section", "sector", "significant", "similar", "source", "specific", "structure", "theory", "variables", "achieve",
        "acquisition", "administration", "affect", "appropriate", "aspects", "assistance", "categories", "chapter", "commission",
        "community", "complex", "computer", "conclusion", "conduct", "consequences", "construction", "consumer", "credit",
        "cultural", "design", "distinction", "elements", "equation", "evaluation", "features", "final", "focus", "impact",
        "injury", "institute", "investment", "items", "journal", "maintenance", "normal", "obtained", "participation", "perceive",
        "positive", "potential", "previous", "primary", "purchase", "range", "region", "regulations", "relevant", "resident",
        "resources", "restricted", "security", "sought", "select", "site", "strategies", "survey", "text", "traditional", "transfer",
        "alternative", "circumstances", "comments", "compensation", "components", "consent", "considerable", "constant",
        "constraints", "contribution", "convention", "coordination", "core", "corporate", "corresponding", "criteria", "deduction",
        "demonstrate", "document", "dominant", "emphasis", "ensure", "excluded", "framework", "funds", "illustrated", "immigration",
        "implies", "initial", "instance", "interaction", "justification", "layer", "link", "location", "maximum", "minorities",
        "negative", "outcomes", "partnership", "philosophy", "physical", "proportion", "published", "reaction", "registered",
        "reliance", "removed", "scheme", "sequence", "sex", "shift", "specified", "sufficient", "task", "technical", "techniques",
        "technology", "validity", "volume", "access", "adequate", "annual", "apparent", "approximated", "attitudes", "attributed",
        "civil", "code", "commitment", "communication", "concentration", "conference", "contrast", "cycle", "debate", "despite",
        "dimensions", "domestic", "emerged", "error", "ethnic", "goals", "granted", "hence", "hypothesis", "implementation",
        "implications", "imposed", "integration", "internal", "investigation", "job", "label", "mechanism", "obvious",
        "occupational", "option", "output", "overall", "parallel", "parameters", "phase", "predicted", "principal", "prior",
        "professional", "project", "promote", "regime", "resolution", "retained", "series", "statistics", "status", "stress",
        "subsequent", "sum", "summary", "undertaken", "academic", "adjustment", "alter", "amendment", "aware", "capacity",
        "challenge", "clause", "compounds", "conflict", "consultation", "contact", "decline", "discretion", "draft", "enable",
        "energy", "enforcement", "entities", "equivalent", "evolution", "expansion", "exposure", "external", "facilitate",
        "fundamental", "generated", "generation", "image", "liberal", "licence", "logic", "margin", "medical", "mental",
        "modified", "monitoring", "network", "notion", "objective", "orientation", "perspective", "precise", "prime",
        "psychology", "pursue", "ratio", "rejected", "revenue", "stability", "styles", "substitution", "sustainable", "symbolic",
        "target", "transition", "trend", "version", "welfare", "whereas", "abstract", "accurate", "acknowledged", "aggregate",
        "allocation", "assigned", "attached", "author", "bond", "brief", "capable", "cited", "cooperative", "discrimination",
        "display", "diversity", "domain", "edition", "enhanced", "estate", "exceed", "expert", "explicit", "federal", "fees",
        "flexibility", "furthermore", "gender", "ignored", "incentive", "incidence", "incorporated", "index", "inhibition",
        "initiatives", "input", "instructions", "intelligence", "interval", "lecture", "migration", "minimum", "ministry",
        "motivation", "neutral", "nevertheless", "overseas", "preceding", "presumption", "rational", "recovery", "revealed",
        "scope", "subsidiary", "tapes", "trace", "transformation", "transport", "underlying", "utility", "visible", "advocate",
        "aide", "channel", "chemical", "classical", "comprehensive", "comprise", "confirmed", "contrary", "converted", "couple",
        "decades", "definite", "deny", "differentiation", "disposal", "dynamic", "eliminate", "empirical", "equipment", "extract",
        "file", "finite", "foundation", "global", "grade", "guarantee", "hierarchical", "identical", "ideology", "inferred",
        "innovation", "insert", "intervention", "isolated", "media", "mode", "paradigm", "phenomenon", "priority", "prohibited",
        "publication", "quotation", "release", "reverse", "simulation", "sole", "somewhat", "submitted", "successive", "survive",
        "thesis", "topic", "transmission", "ultimately", "unique", "voluntary", "abandon", "accompanied", "accumulation",
        "ambiguous", "appendix", "appreciation", "arbitrary", "automatically", "bias", "chart", "clarity", "conformity",
        "commodity", "complement", "contemporary", "contradiction", "crucial", "currency", "denote", "detected", "deviation",
        "displacement", "dramatic", "eventually", "exhibit", "exploitation", "fluctuations", "guidelines", "highlighted",
        "implicit", "induced", "inevitably", "infrastructure", "inspection", "intensity", "manipulation", "minimised", "nuclear",
        "offsets", "paragraph", "plus", "practitioners", "predominantly", "prospect", "radical", "random", "reinforced",
        "restore", "revision", "schedule", "tension", "termination", "theme", "thereby", "uniform", "vehicle", "via", "virtual",
        "visual", "widespread", "accommodate", "analogy", "anticipated", "assurance", "attained", "behalf", "bulk", "ceases",
        "coherence", "coincide", "commenced", "incompatible", "concurrent", "confined", "controversy", "conversely", "device",
        "devoted", "diminished", "distortion", "duration", "erosion", "ethical", "format", "founded", "inherent", "insight",
        "integral", "intermediate", "manual", "mature", "mediation", "medium", "military", "minimal", "mutual", "normals",
        "overlap", "passive", "portion", "preliminary", "protocol", "qualitative", "refine", "relaxed", "restraints", "revolution",
        "rigid", "route", "scenario", "sphere", "subordinate", "supplementary", "suspended", "team", "temporary", "trigger",
        "unified", "violation", "vision", "adjacent", "albeit", "assembly", "collapse", "colleagues", "compiled", "conceived",
        "convinced", "depression", "encountered", "enormous", "forthcoming", "inclination", "integrity", "intrinsic", "invocation",
        "levy", "likewise", "nonetheless", "notwithstanding", "odd", "ongoing", "panel", "persistent", "posed", "reluctance",
        "socalled", "straightforward", "undergo", "whereby"
    ]);

    const CONNECTORS = [
        "however", "moreover", "furthermore", "nevertheless", "nonetheless", "consequently", "therefore", "thus", "hence",
        "initially", "subsequently", "finally", "specifically", "alternatively", "conversely", "meanwhile", "likewise",
        "notably", "similarly", "accordingly", "additionally", "incidentally", "undoubtedly", "admittedly", "besides",
        "instead", "otherwise", "contrastingly", "comparatively", "ultimately", "overall"
    ];

    /* --- LOGIC --- */

    function getEl(id) { return document.getElementById(id); }

    function setRandomPrompt() {
        const prompts = [
            "Some people believe that the government should provide free healthcare for all citizens. To what extent do you agree or disagree?",
            "With the rise of technology, many traditional skills are being lost. Do the benefits of technology outweigh the disadvantages?",
            "In many countries, plastic shopping bags are the main source of rubbish. This has caused pollution of land and water. What do you think are the main problems associated with this? What measures can be taken to solve them?",
            "Some people think that schools should select students according to their academic abilities, while others believe that it is better to have students of different abilities studying together. Discuss both views and give your own opinion."
        ];
        getEl('promptInput').value = prompts[Math.floor(Math.random() * prompts.length)];
    }

    function loadDemo() {
        setRandomPrompt();
        const demoEssay = "It is often argued that the responsibility for recycling should lie with the government rather than individuals. While government regulation is crucial, I believe that a collaborative approach involving both legal frameworks and individual action is necessary to solve the waste crisis.\n\nOn the one hand, the government plays a pivotal role in waste management. Without adequate infrastructure, such as recycling plants and convenient collection systems, individual efforts are rendered futile. For instance, if a city lacks separate bins for glass and paper, citizens cannot recycle effectively regardless of their intentions. Furthermore, governments have the authority to enforce legislation, such as banning single-use plastics or imposing fines on companies that produce excessive packaging. These systemic changes have a far-reaching impact that voluntary individual actions cannot match.\n\nOn the other hand, legislation alone is insufficient without public compliance. Laws can be passed, but if citizens are apathetic, the system fails. For example, even in countries with strict recycling laws, contamination of recycling bins with non-recyclable waste remains a significant issue. This demonstrates that education and a shift in public mindset are equally important. Individuals must make conscious choices to reduce consumption and segregate waste correctly. Collective individual action creates a culture of sustainability that reinforces government policy.\n\nIn conclusion, while the government must provide the infrastructure and legal framework for recycling, individuals hold the power to make these systems work. Therefore, solving the problem of waste requires a dual approach where state intervention and personal responsibility go hand in hand.";
        getEl('essayInput').value = demoEssay;
        updateWordCount();
    }

    function updateWordCount() {
        const text = getEl('essayInput').value.trim();
        const count = text ? text.split(/\s+/).length : 0;
        getEl('wordCountDisplay').textContent = count + " words";
        return count;
    }

    getEl('essayInput').addEventListener('input', updateWordCount);

    /* --- CORE ANALYZER --- */

    function analyzeEssay() {
        const text = getEl('essayInput').value.trim();
        const prompt = getEl('promptInput').value.trim();

        if (!text) {
            alert("Please write an essay first.");
            return;
        }

        // UI Transition
        getEl('emptyState').classList.add('hidden');
        getEl('resultsContainer').classList.remove('hidden');

        // Scroll to results on mobile
        if (window.innerWidth < 1024) {
            setTimeout(() => {
                document.getElementById('resultsContainer').scrollIntoView({ behavior: 'smooth' });
            }, 100);
        }

        // Pre-processing
        const words = text.match(/\b[a-zA-Z-]+\b/g) || [];
        const sentences = text.match(/[^.!?]+[.!?]+/g) || [];
        const paragraphs = text.split(/\n\s*\n/).filter(p => p.trim().length > 0);
        const wordCount = words.length;

        // 1. Calculate TR (Task Response)
        const trResult = calculateTR(wordCount, paragraphs, prompt, text);
        
        // 2. Calculate CC (Coherence Cohesion)
        const ccResult = calculateCC(text, sentences, paragraphs);

        // 3. Calculate LR (Lexical Resource)
        const lrResult = calculateLR(words);

        // 4. Calculate GRA (Grammar)
        const graResult = calculateGRA(sentences, text);

        // 5. Final Scoring (Weighted Calculation)
        // IELTS truncates to nearest 0.5 or whole number.
        const avg = (trResult.score + ccResult.score + lrResult.score + graResult.score) / 4;
        
        // Rounding logic matching IELTS (e.g. 6.25 -> 6.5, 6.75 -> 7.0)
        let finalScore = Math.floor(avg * 4) / 4; // Get quarter steps
        if (finalScore % 1 === 0.25) finalScore += 0.25; // Round up to .5
        else if (finalScore % 1 === 0.75) finalScore += 0.25; // Round up to next whole
        
        // Display Results
        displayResults(finalScore, trResult, ccResult, lrResult, graResult);
    }

    /* --- SCORING ENGINES (More Realistic/Fair) --- */

    function calculateTR(count, paragraphs, prompt, text) {
        let score = 6.0;
        let feedback = "";
        
        // Length Logic (Fairer: <250 is not instant fail, but penalty)
        if (count >= 250) score += 1.0; 
        else if (count >= 230) score += 0.5;
        else score -= 0.5;

        // Structure Logic
        const hasIntro = paragraphs.length > 1; 
        const hasConclusion = paragraphs.length > 2 && 
            /conclusion|summar|overall|conclude/.test(paragraphs[paragraphs.length-1].toLowerCase());
        
        if (hasIntro && hasConclusion) score += 1.0;
        else if (hasConclusion) score += 0.5;
        else feedback += " Conclusion seems missing or unclear.";

        // Relevance (Simple keyword matching against prompt)
        if (prompt.length > 5) {
            const promptWords = prompt.toLowerCase().match(/\b\w{4,}\b/g) || [];
            const essayLower = text.toLowerCase();
            let hits = 0;
            promptWords.forEach(w => { if(essayLower.includes(w)) hits++; });
            const coverage = hits / promptWords.length;
            
            if (coverage > 0.5) score += 0.5; // Good coverage
            if (coverage < 0.2) { score -= 0.5; feedback += " Topic relevance seems low."; }
        }

        // Cap score
        score = Math.min(9, Math.max(4, score));

        // Generate Narrative
        if (score >= 8) feedback = "Excellent length and structural development. The essay fully addresses the prompt requirements.";
        else if (score >= 7) feedback = "Good response. The main parts are clear and the length is appropriate.";
        else if (score >= 6) feedback = "Relevant response, but could be more fully developed or lacks a strong conclusion.";
        else feedback = "The response may be underlength or fails to fully address the prompt.";

        return { score, feedback, count };
    }

    function calculateCC(text, sentences, paragraphs) {
        let score = 5.0;
        
        // Paragraphing (3-5 is sweet spot)
        if (paragraphs.length >= 3 && paragraphs.length <= 5) score += 1.5;
        else if (paragraphs.length >= 2) score += 0.5;

        // Connector Usage
        let usedConnectors = [];
        CONNECTORS.forEach(c => {
            if (new RegExp(`\\b${c}\\b`, 'i').test(text)) usedConnectors.push(c);
        });
        
        // Density Check (Don't overuse!)
        const ratio = usedConnectors.length / sentences.length;
        if (ratio > 0.15 && ratio < 0.5) score += 1.5; // Sweet spot
        else if (ratio >= 0.5) score += 0.5; // Too mechanical
        else if (ratio > 0) score += 0.5; // Too few

        score = Math.min(9, Math.max(4, score));

        let feedback = "";
        if (score >= 8) feedback = "Seamless flow. Paragraphing is logical and cohesive devices are used naturally.";
        else if (score >= 7) feedback = "Good organization. There is a clear central topic within each paragraph.";
        else if (score >= 6) feedback = "Coherent, but some linking words may feel mechanical or faulty.";
        else feedback = "Paragraphing may be inadequate or linking devices are missing.";

        return { score, feedback, usedConnectors };
    }

    function calculateLR(words) {
        let score = 5.0;
        const uniqueWords = new Set(words.map(w => w.toLowerCase()));
        const totalUnique = uniqueWords.size;
        
        // Academic Density
        let academicCount = 0;
        let academicFound = [];
        uniqueWords.forEach(w => {
            if (ACADEMIC_VOCAB.has(w)) {
                academicCount++;
                academicFound.push(w);
            }
        });

        // Repetition Check
        const freq = {};
        words.forEach(w => {
            if (w.length > 4) freq[w] = (freq[w] || 0) + 1;
        });
        const repeats = Object.keys(freq).filter(w => freq[w] > 4 && !ACADEMIC_VOCAB.has(w)); // Allow repeating academic words slightly more

        // Scoring Logic
        const density = academicCount / words.length;
        
        if (density > 0.12) score += 3.0; // Band 8+ potential
        else if (density > 0.08) score += 2.0; // Band 7
        else if (density > 0.04) score += 1.0; // Band 6

        // Penalty for extreme repetition
        if (repeats.length > 3) score -= 0.5;

        score = Math.min(9, Math.max(4, score));

        let feedback = "";
        if (score >= 8) feedback = "Wide range of vocabulary used naturally and flexibly. Rare items used skillfully.";
        else if (score >= 7) feedback = "Sufficient range to allow some flexibility and precision. Uses less common items.";
        else if (score >= 6) feedback = "Adequate range for the task. Attempts to use less common vocabulary but with some inaccuracy.";
        else feedback = "Vocabulary is limited or basic. Frequent repetition.";

        return { score, feedback, academicFound, repeats };
    }

    function calculateGRA(sentences, text) {
        let score = 5.0;
        
        // 1. Sentence Length Variety (Standard Deviation approximation)
        const lengths = sentences.map(s => s.split(/\s+/).length);
        const avgLen = lengths.reduce((a,b)=>a+b,0) / lengths.length;
        
        // Check for complexity markers (subordinating conjunctions, semicolons)
        const complexMarkers = /although|however|despite|which|that|because|while|whereas|if|unless|;|:/gi;
        const complexSentences = sentences.filter(s => s.match(complexMarkers)).length;
        const complexRatio = complexSentences / sentences.length;

        if (complexRatio > 0.6) score += 2.5; // Very complex
        else if (complexRatio > 0.4) score += 1.5; // Moderately complex
        else if (complexRatio > 0.2) score += 0.5;

        // Length bonus (longer sentences usually imply better grammar control in IELTS context)
        if (avgLen > 18) score += 1.0;
        else if (avgLen > 12) score += 0.5;

        // Passive voice detection (heuristic)
        const passive = /\b(is|are|was|were|be|been|being)\b\s\w+ed\b/gi;
        if (text.match(passive)) score += 0.5;

        score = Math.min(9, Math.max(4, score));

        let feedback = "";
        if (score >= 8) feedback = "Wide range of structures. The majority of sentences are error-free.";
        else if (score >= 7) feedback = "Uses a variety of complex structures. Produces frequent error-free sentences.";
        else if (score >= 6) feedback = "Mix of simple and complex forms. Meaning is rarely obscured by errors.";
        else feedback = "Limited range of structures. Frequent grammatical errors.";

        return { score, feedback, avgLen, complexRatio };
    }

    /* --- UI RENDERING --- */

    function displayResults(final, tr, cc, lr, gra) {
        // Update Big Score
        animateValue("scoreBig", 0, final, 1000);
        
        // Update CEFR/Summary
        const summaryEl = getEl('scoreSummary');
        const cefrEl = getEl('cefrLevel');
        
        if (final >= 8) {
            summaryEl.textContent = "An expert user response. Fluent, precise, and highly sophisticated.";
            cefrEl.textContent = "C2 Proficiency";
            cefrEl.className = "px-3 py-0.5 rounded-full bg-purple-500 text-white text-sm font-semibold";
        } else if (final >= 7) {
            summaryEl.textContent = "A good user response. Handles complex argumentation well with occasional errors.";
            cefrEl.textContent = "C1 Advanced";
            cefrEl.className = "px-3 py-0.5 rounded-full bg-blue-500 text-white text-sm font-semibold";
        } else if (final >= 6) {
            summaryEl.textContent = "A competent response. Address the task but may lack nuance or have some errors.";
            cefrEl.textContent = "B2 Upper Intermediate";
            cefrEl.className = "px-3 py-0.5 rounded-full bg-green-500 text-white text-sm font-semibold";
        } else {
            summaryEl.textContent = "A modest response. Requires more development and vocabulary range.";
            cefrEl.textContent = "B1 Intermediate";
            cefrEl.className = "px-3 py-0.5 rounded-full bg-orange-500 text-white text-sm font-semibold";
        }

        // Update Grid
        getEl('trScore').textContent = tr.score.toFixed(1);
        getEl('trFeedback').textContent = tr.feedback;
        getEl('trCheckWords').textContent = `${tr.count} / 250`;
        getEl('trBar').style.width = Math.min(100, (tr.count/250)*100) + "%";

        getEl('ccScore').textContent = cc.score.toFixed(1);
        getEl('ccFeedback').textContent = cc.feedback;
        const tags = getEl('connectorTags');
        tags.innerHTML = '';
        cc.usedConnectors.slice(0, 8).forEach(c => {
            tags.innerHTML += `<span class="px-2 py-1 bg-white border border-slate-200 rounded text-xs text-slate-600">${c}</span>`;
        });

        getEl('lrScore').textContent = lr.score.toFixed(1);
        getEl('lrFeedback').textContent = lr.feedback;
        const vList = getEl('vocabList');
        vList.innerHTML = '';
        if(lr.academicFound.length === 0) vList.innerHTML = '<span class="text-xs text-slate-400">No advanced words detected.</span>';
        else {
            lr.academicFound.slice(0,12).forEach(w => {
                 vList.innerHTML += `<span class="px-2 py-1 bg-purple-100 text-purple-700 rounded text-xs font-bold">${w}</span>`;
            });
        }

        getEl('graScore').textContent = gra.score.toFixed(1);
        getEl('graFeedback').textContent = gra.feedback;
        getEl('sentLenAvg').textContent = Math.round(gra.avgLen);
        getEl('complexScore').textContent = Math.round(gra.complexRatio * 100) + "%";

        // Recommendations
        renderSuggestions(tr, cc, lr, gra);
    }

    function renderSuggestions(tr, cc, lr, gra) {
        const list = getEl('nextStepsList');
        list.innerHTML = '';

        // Repetition
        const repBox = getEl('repetitionBox');
        const repList = getEl('repList');
        if (lr.repeats.length > 0) {
            repBox.classList.remove('hidden');
            repList.innerHTML = '';
            lr.repeats.forEach(w => {
                repList.innerHTML += `<span class="px-2 py-1 bg-red-100 text-red-700 rounded text-xs font-bold line-through">${w}</span>`;
            });
        } else {
            repBox.classList.add('hidden');
        }

        // Smart Tips
        if (tr.count < 260) list.innerHTML += `<li><strong>Expand your ideas:</strong> You are close to the minimum word count. Add an example to your second body paragraph.</li>`;
        if (gra.complexRatio < 0.4) list.innerHTML += `<li><strong>Vary sentence structure:</strong> Try starting sentences with "Although...", "While...", or "Despite..." to create complexity.</li>`;
        if (lr.academicFound.length < 10) list.innerHTML += `<li><strong>Upgrade vocabulary:</strong> Replace common verbs like "get", "do", or "make" with more precise synonyms (e.g., "acquire", "conduct", "generate").</li>`;
        if (cc.score < 7 && cc.usedConnectors.length < 5) list.innerHTML += `<li><strong>Improve flow:</strong> Use more linking words to guide the reader (e.g., "Furthermore", "Consequently", "In contrast").</li>`;
        
        if (list.innerHTML === '') list.innerHTML = `<li><strong>Polish:</strong> Your essay is strong! Focus on proofreading for minor spelling or punctuation errors to secure a Band 9.</li>`;
    }

    function animateValue(id, start, end, duration) {
        const range = end - start;
        let current = start;
        const increment = end > start ? 0.1 : -0.1;
        const stepTime = Math.abs(Math.floor(duration / (range / 0.1)));
        const obj = document.getElementById(id);
        
        const timer = setInterval(function() {
            current += increment;
            obj.innerHTML = current.toFixed(1);
            if ((increment > 0 && current >= end) || (increment < 0 && current <= end)) {
                obj.innerHTML = end.toFixed(1);
                clearInterval(timer);
            }
        }, stepTime);
    }

</script>
</body>
</html>
